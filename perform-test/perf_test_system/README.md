## 性能测试介绍
### 性能测试概念
* step1：【性能指标】性能测试针对系统的性能指标；
  * 时间指标
    * 响应时间的 258 原则合理吗？
      * 距离这个统计结果的出现，已经过去快 40 年了，IT 发展的都能上天了，这个时间现在已经完全不适用了。所以，以后出去别再提 258/2510 响应时间原则这样的话了，太不专业。
    * 那么响应时间如何设计比较合理呢？这里有两种思路推荐给你。
      1. 同行业的对比数据。
      2. 找到使用系统的样本用户（越多越好），对他们做统计，将结果拿出来，就是最有效的响应时间的制定标准
  * 容量指标
  * 资源利用率指标
* step2：【性能模型】建立性能测试模型；
  * 参考资源：https://mp.weixin.qq.com/s/C2xnFhsRpacqDXc0uIX03w
  * 模型是什么？它是真实场景的抽象，可以告诉性能测试人员，业务模型是什么样子
  * 比如说，我们有 100 种业务，但不是每个业务都需要有并发量，可能只有 50 个业务有，那就要把这些有并发的业务统计出来，哪个业务并发多，哪个业务并发少，做压力时就要控制好这样的比例。
  * 业务模型的 28 原则是个什么鬼？--【这种方式不靠谱】
    * 如果一天有 1000 万的用户在使用，系统如果开 10 个小时的话，在计算并发用户数的时候，就用 2 小时来计算，即 1000 万用户在 2 小时内完成业务
  * 模型来源：
    * 来源1：生产环境中的数据中统计来
      * 根据生产环境的统计信息做业务比例的统计，然后设定到压力工具中。有很多不能在线上直接做压力测试的系统，都通过这种方式获取业务模型。
    * 来源2：线上导流
      * 直接在生产环境中做流量复制的方式或压力工具直接对生产环境发起压力的方式做压力测试。这种方式被很多人称为全链路压测。其实在生产中做压力测试的方式，最重要的工作不是技术，而是组织协调能力。相信参与过的人都能体会这句话的重量
* step3：【性能场景】制定性能测试方案；
  * 关键点分别是：测试环境、测试数据、测试模型、性能指标、压力策略、准入准出和进度风险
  * 怎么没有测试计划？我的建议是，用项目管理工具单独画测试计划，比如用 Project 或 OmniPlan 之类的工具
    >这是因为在方案中，写测试计划，基本上只能写一个里程碑，再细化一点，就是在里面再加几个大阶段的条目。但是用项目管理工具做计划就不同了，它不仅可以细分条目，还能跟踪各个工作的动态进度，可以设置前后依赖关系，填入资源和成本以便计算项目偏差。
* step4：【性能监控】制定监控策略；
  * 监控，要有分层、分段的能力，要有全局监控、定向监控的能力
* step5：【性能实施】在场景条件之下执行性能场景；
  1. 基准性能场景：这里要做的是单交易的容量，为混合容量做准备（不要跟我说上几个线程跑三五遍脚本叫基准测试，在我看来，那只是场景执行之前的预执行，用来确定有没有基本的脚本和场景设计问题，不能称之为一个分类）。
  2. 容量性能场景：这一环节必然是最核心的性能执行部分。根据业务复杂度的不同，这部分的场景会设计出很多个，在概念部分就不细展开了
  3. 稳定性性能场景：稳定性测试必然是性能场景的一个分类。只是现在在实际的项目中，稳定性测试基本没和生产一致过。在稳定性测试中，显然最核心的元素是时间（业务模型已经在容量场景中确定了），而时间的设置应该来自于运维周期，而不是来自于老板、产品和架构等这些人的心理安全感。
  4. 异常性能场景：要做异常性能场景，前提就是要有压力。在压力流量之下，模拟异常。这个异常的定义是很宽泛的
* step6：【性能调优】分析判断性能瓶颈并调优；
* step7：【性能报告】最终得出性能结果来评估系统的性能指标是否满足既定值。
![性能概念图](../images/性能概念图.webp)
### 场景的定义来替换这些混乱的性能概念
![性能场景](../images/性能场景.webp)
#### 为什么我要如此划分？
* 在具体场景的操作层面，只有场景中的配置才是具体可操作的。
  * 而通常大家认为的性能测试、负载测试、压力测试在操作的层面，只有压力工具中线程数的区别，
  * 其他的都在资源分析的层面，而分析在很多人的眼中，都不算测试。
### 性能指标（怎么理解TPS、QPS、RT、吞吐量这些性能指标？）
>通常我们都从两个层面定义性能场景的需求指标：业务指标和技术指标。   
> 这两个层面需要有映射关系，技术指标不能脱离业务指标。一旦脱离，你会发现你能回答“一个系统在多少响应时间之下能支持多少 TPS”这样的问题，但是回答不了“业务状态是什么”的问题。
#### 1.业务指标和性能指标之间的关系
![业务指标vs性能指标](../images/业务指标vs性能指标.webp)
* 所有的技术指标都是在有业务场景的前提下制定的
* 而技术指标和业务指标之间也要有详细的换算过程
* 这样一来,技术指标就**不会是一块飞地**。同时，在回答了技术指标是否满足的同时，也能回答是否可以满足业务指标
#### 2.测试行业常用的性能指标表示法
![](../images/性能指标表示法.webp)
#### 3.压力工具中的线程数和用户数与 TPS
![](../images/用户-%3Etps-%3E线程数.webp)
响应时间肯定不会一直都是 100ms 的嘛。所以通常情况下，上面的这个比例都不会固定，而是随着并发线程数的增加，会出现**趋势**上的关系
* 结论：应该用TPS来承载系统的并发这个概念，而不是jmeter中的线程数
### 性能项目分类
#### 新系统性能测试类：
这样的项目一般都会要求测试出系统的最大容量，不然上线心里没底。
#### 旧系统新版本性能测试类：
这样的项目一般都是和旧版本对比，只要性能不下降就可以根据历史数据推算容量，对调优要求一般都不大。
#### 新系统性能测试优化类：
这类的系统不仅要测试出最大容量，还要求调优到最好
### 性能团队的职责
>性能只测不调，那就是性能验证的工作，称不上是完整的性能项目   
> 那为啥好多项目不进行调优呢？   
> 1. 性能测试团队的人能力有限做不到
> 2. 性能调优代价高，耗时长，不值得做
1. 性能验证：针对给定的指标，只做性能验证。第三方测试机构基本上都是这样做的。
2. 性能测试：针对给定的系统，做全面的性能测试，可以得到系统最大容量，但不涉及到调优。
3. 性能测试 + 分析调优：针对给定的系统，做全面的性能测试，同时将系统调优到最优状态。
### 优势
* 为企业降本增效
  * 良好的容量规划能⼒ + 性能调优能⼒ = 为⽼板省钱
* 性能测试能⼒是测开⼯程师精华加分项
### TPS和响应时间的关系
#### 【这图过于理想了】性能测试模型-曲线拐点模型-压力曲线分析图
![拐点图.png](..%2Fimages%2F%E6%8B%90%E7%82%B9%E5%9B%BE.png)
>做为一个示意图，它真的非常经典，的确描述出了一个基本的状态。但是，示意图也只能用来做示意图，在具体的项目中，我们仍然要有自己明确的判断。   
> 这张图呢，本来只是一个示意，用以说明一些关系。但是后来在性能行业中，有很多没有完全理解此图的人将它做为很有道理的“典范”给一些人讲，从而引起了越来越多的误解。
* 横轴：从左到右表现了Number of Concurrent Users（并发用户数）的不断增长。
* 三条曲线：
  * Utilization（资源的利用情况，包括硬件资源和软件资源）、
  * Throughput（吞吐量，这里是指每秒事务数）
  * Response Time（响应时间）
* 三个区域：
  * Light Load （轻压力区）
  * Heavy Load （重压力区）
  * Buckle Zone（弃忍区）
* 两个点
  * The Optimum Number of Concurrent Users（最佳并发用户数）
    * 在Light Load和Heavy Load两个区域交界处的并发用户数；
  * The Maximum Number of Concurrent Users（最大并发用户数）
    * 在Heavy Load和Buckle Zone两个区域交界处的并发用户数；
* 三个状态描述
  * 资源饱和（Resource Saturated）
  * 吞吐下降（Throughput Falling）
  * 用户受影响（End Users Effected）
#### 【符合实际】TPS和响应时间关系图
![TPS和响应时间关系图](../images/tps图.webp)
* 上图中蓝线表示 TPS，黄色表示响应时间。
* 描述：
  * 在 TPS 增加的过程中，响应时间一开始会处在较低的状态，也就是在 A 点之前。
  * 接着响应时间开始有些增加，直到业务可以承受的时间点 B，这时 TPS 仍然有增长的空间。
  * 再接着增加压力，达到 C 点时，达到最大 TPS。
  * 我们再接着增加压力，响应时间接着增加，但 TPS 会有下降（请注意，这里并不是必然的，有些系统在队列上处理得很好，会保持稳定的 TPS，然后多出来的请求都被友好拒绝）
* 最后，响应时间过长，达到了超时的程度。
* 在我的工作中，这样的逻辑关系更符合真实的场景。我**不希望在这个关系中描述资源的情况，因为会让人感觉太乱了**。
## 行业流行性能压测工具介绍
### 工具分类
![](../images/工具分类.webp)
>你是不是有一种生无可恋的感觉？一个性能测试而已，有必要搞出这么多工具吗？
>然而，你要记住，这些都是压力发起工具。
* Apache AB = Apache HTTP server benchmarking tool
  * 小快灵
  * https://httpd.apache.org/docs/2.4/programs/ab.html
* Jmeter
  * https://jmeter.apache.org/
  * 压测场景支撑：逻辑控制器
  * 压力需求：分布式
  * CI支持：Jmx文件、数据驱动、场景可视化
  * 二次开发：多协议支持
  * 问题支持：开源社区
* nGrinder
  * https://github.com/naver/ngrinder
* Locust
  * https://github.com/locustio/locust
### 工具对比
![](../images/工具比对.webp)
#### Jmeter vs Locust
https://www.blazemeter.com/blog/how-to-test-concurrent-users-using-jmeter
### 使用性能测试工具的**误区**在哪里？
> 所以工具应该如何用，完全取决于用的人，而不是工具本身。
* 压测工具也好，压测平台也好，都没有一个工具可以直接告诉你瓶颈在哪里，
* 能告诉你的只是数据是什么。
* 分析只有靠自己，在这个过程中，我们也会用到很多的分析剖析工具，用这些工具的人也都会知道，
* 工具也只提供数据，不会告诉你瓶颈点在哪里。
### 测试方法
#### 并发模式
并发模式（虚拟⽤户模式） 并发是指虚拟并发⽤户数，从业务⾓度，也可以理解
为同时在线的⽤户数。如果需要从客户端的⾓度出发，摸底业务系统各节点能同
时承载的在线⽤户数，可以使⽤该模式设置⽬标并发。
#### RPS模式（吞吐量模式）
RPS 模式（吞吐量模式） RPS（Requests Per Second）是指每秒请求数。RPS 模
式即“吞吐量模式”，通过设置每秒发出的请求数，从服务端的⾓度出发，直接衡
量系统的吞吐能⼒，免去并发到 RPS 的繁琐转化，⼀步到位。
>有经验的性能测试人员，都会更关心服务端能处理的请求数即 TPS，而不是压力工具中的线程数。

## 经典技术架构图
![架构图.png](..%2Fimages%2F%E6%9E%B6%E6%9E%84%E5%9B%BE.png)