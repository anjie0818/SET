## Linux相关指令
### io 指标监控命令
* df -h
    * 命令描述： 列出⽂件系统的整体磁盘空间使⽤情况
#### iostat
    * 参数：
    * -x:查看最后一个参数%util，此值大小觉得io读写的繁忙程度
    * [指定磁盘]：指定查看的硬盘
    * num :间隔时间
### cpu 指标监控命令
* uptime
    * 命令描述： 用于显示系统总共运行了多长时间和系统的平均负载
* cat /proc/cpuinfo
    * 命令描述： 查看CPU的配置信息
* sar -u 1 1
    * 命令描述： 是一个Linux下的监控工具，可以用来监控CPU性能状况
#### 时实监控-cpu
* mpstat:特点：可以查看*多核心cpu中每个计算核心的统计数据*
* mpstat [-P{|ALL}][interal[count]]
* 参数
    * -P：定位监控的cpu，cpu在[0,cpu个数-1]中取值
    * interal: 相邻的俩次采样的间隔时间
    * count:采样次数
* 注意：没有参数显示系统启动以后所有信息的平均值   
  有interval:第一行显示系统启动以后所有信息的平均值，从第二行开始看
### 内存 指标监控命令
* cat /proc/meminfo
    * 查看内存相关配置信息
#### free
* 用途：监控系统内存使用状态，
* 参数讲解：
    * total:总计物理内存的大小；used:已经使用的；free可用的；shared:多个进程共享内存总额；buffers/cached:磁盘缓存大小
    * free -h 加单位显示
#### vmstat参数
* 用途：监控系统进程的状态/内存/虚拟内存/磁盘io/cpu消息
* 参数：
    * -S:使用指定的单位显示-默认：K，eg:k(1000) K(1024) m(1000000) M(1048576)字节
* 实例：  vmstat  时间间隔     显示次数
* 图例讲解
  ![](../images/vmstat.png)
    * r 表示运行队列(就是说多少个进程真的分配到CPU)，我测试的服务器目前CPU比较空闲，没什么程序在跑，当这个值超过了CPU数目，就会出现CPU瓶颈了。这个也和top的负载有关系，一般负载超过了3就比较高，超过了5就高，超过了10就不正常了，服务器的状态很危险。top的负载类似每秒的运行队列。如果运行队列过大，表示你的CPU很繁忙，一般会造成CPU使用率很高。
    * b 表示阻塞的进程,这个不多说，进程阻塞，大家懂的。
    * swpd 虚拟内存已使用的大小，如果大于0，表示你的机器物理内存不足了，如果不是程序内存泄露的原因，那么你该升级内存了或者把耗内存的任务迁移到其他机器。
    * free   空闲的物理内存的大小，我的机器内存总共8G，剩余3415M。
    * buff   Linux/Unix系统是用来存储，目录里面有什么内容，权限等的缓存，我本机大概占用300多M
    * cache cache直接用来记忆我们打开的文件,给文件做缓冲，我本机大概占用300多M(这里是Linux/Unix的聪明之处，把空闲的物理内存的一部分拿来做文件和目录的缓存，是为了提高 程序执行的性能，当程序使用内存时，buffer/cached会很快地被使用。)
    * si  每秒从磁盘读入虚拟内存的大小，如果这个值大于0，表示物理内存不够用或者内存泄露了，要查找耗内存进程解决掉。我的机器内存充裕，一切正常。
    * so  每秒虚拟内存写入磁盘的大小，如果这个值大于0，同上。
    * bi  块设备每秒接收的块数量，这里的块设备是指系统上所有的磁盘和其他块设备，默认块大小是1024byte，我本机上没什么IO操作，所以一直是0，但是我曾在处理拷贝大量数据(2-3T)的机器上看过可以达到140000/s，磁盘写入速度差不多140M每秒
    * bo 块设备每秒发送的块数量，例如我们读取文件，bo就要大于0。bi和bo一般都要接近0，不然就是IO过于频繁，需要调整。
    * in 每秒CPU的中断次数，包括时间中断
    * cs 每秒上下文切换次数，例如我们调用系统函数，就要进行上下文切换，线程的切换，也要进程上下文切换，这个值要越小越好，太大了，要考虑调低线程或者进程的数目,例如在apache和nginx这种web服务器中，我们一般做性能测试时会进行几千并发甚至几万并发的测试，选择web服务器的进程可以由进程或者线程的峰值一直下调，压测，直到cs到一个比较小的值，这个进程和线程数就是比较合适的值了。系统调用也是，每次调用系统函数，我们的代码就会进入内核空间，导致上下文切换，这个是很耗资源，也要尽量避免频繁调用系统函数。上下文切换次数过多表示你的CPU大部分浪费在上下文切换，导致CPU干正经事的时间少了，CPU没有充分利用，是不可取的。
    * us 用户CPU时间，我曾经在一个做加密解密很频繁的服务器上，可以看到us接近100,r运行队列达到80(机器在做压力测试，性能表现不佳)。
    * sy 系统CPU时间，如果太高，表示系统调用时间长，例如是IO操作频繁。
    * id  空闲 CPU时间，一般来说，id + us + sy = 100,一般我认为id是空闲CPU使用率，us是用户CPU使用率，sy是系统CPU使用率。
    * wt 等待IO CPU时间
### net 指标监控命令
* ping
    * 向目标系统发送报文，检测网络连通性的工具
* ifconfig
    * 用于获取网卡配置与网络状态等信息
* hostname
    * 显示本机的hostname, 修改本机的hostname
#### netstat
    * 参数：
    * -n：拒绝显示别名，能显示数字的显示数字
    * -l：仅列出监听的服务状态
    * -p：显示建立链接的程序名
    * -t(tcp):显示tcp相关选项
    * -u(udp):显示udp相关选项
    * -i：显示自动匹配接口的信息
    * -c: 间隔时间
    * 实例：
        * netstat -ntlp（查看此端口是否被监听）
        * netstat -c 间隔时间
        * netstat -i:查看是否有丢失或者错误的数据（查看网络传输大小和是否有error）
            ```
            Iface             MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
            docker0          1500   153095      0      0 0        203677      0      0      0 BMRU
            eth0             1500  3368793      0      0 0       3348217      0      0      0 BMRU
            lo              65536   227018      0      0 0        227018      0      0      0 LRU
            vethc67c6dc      1500   129544      0      0 0        156989      0      0      0 BMRU
            
            讲解：
            Iface：网络设备的接口名称
            MTU:最大传输单元（单位字节）
            ```
### top命令
命令描述： 实时的显示系统中各个进程的资源占用情况
#### 核心命令
* 帮助
  * h
* 杀死进程
    * 在top名称执行后，按小k，可以进入进程杀死对话框
* z 彩色/黑白显示
* 监控每个逻辑CPU的状况
    * 在top基本视图中，按键盘数字“1”，可监控每个逻辑CPU的状况
* 进程排序
    * M 根据内存使用情况排序
    * P 根据CPU使用情况排序
    * N 根据进程ID排序
    * T 根据进程使用CPU的时间排序
* 线程运行情况
    * H
* 区分内核进程和显示进程启动路径
    * c 则能够展示进程路径
* 是树形结构展示父子进程关系
    * V
* 基于用户过滤进程
    * u
        * 或者在top启动时，通过加参数来过滤用户top -u root
* 基于表达式过滤进程
    * 在top启动后，按大O，进入过滤表达式的输入框 表达式有以下几种类型
```
COMMAND=getty: Filter processes which contain “getty” in the COMMAND attribute.
!COMMAND=getty: Filter processes which do not have “getty” in the COMMAND attribute.
%CPU>3.0: Filter processes which have a CPU utilization of more than 3%.
输入等号'='，清除filter表达式
```
* 以进度条的形式展示资源使用情况
    * 在top命令下，按t或m来进行进度条显示
* 如何基于进程id，或程序名来查看其资源占用情况
    * 首先基于ps aux | grep processName 找到对应进程的pid 然后使用top -c -p pid方式单过滤查看该进程的资源占用情况
#### top视图说明
* 第一行：   
  10:01:23 — 当前系统时间   
  126 days, 14:29 — 系统已经运行了126天14小时29分钟（在这期间没有重启过）   
  2 users — 当前有2个用户登录系统   
  load average: 1.15, 1.42, 1.44 — load average后面的三个数分别是最近1分钟、5分钟、15分钟的负载情况。      
  load average数据是每隔5秒钟检查一次活跃的进程数，然后按特定算法计算出的数值。如果这个数除以逻辑CPU的数量，结果高于5的时候就表明系统在超负荷运转了。
    * load average: 在特定时间间隔内运行队列中(在CPU上运行或者等待运行多少进程)的平均进程数。
    * 【注意】说明：在单核CPU中load average的值1时表示满负荷状态。同理在多核CPU中满负荷load average的值为1*CPU核数
* 第二行：   
  Tasks — 任务（进程），系统现在共有183个进程，其中处于运行中的有1个，182个在休眠（sleep），stoped状态的有0个，zombie状态（僵尸）的有0个
* 第三行：cpu状态   
  6.7% us — 用户空间占用CPU的百分比。
  0.4% sy — 内核空间占用CPU的百分比。
  0.0% ni — 改变过优先级的进程占用CPU的百分比
  92.9% id — 空闲CPU百分比
  0.0% wa — IO等待占用CPU的百分比
  0.0% hi — 硬中断（Hardware IRQ）占用CPU的百分比
  0.0% si — 软中断（Software Interrupts）占用CPU的百分比
* 第四行：内存状态    
  8306544k total — 物理内存总量（8GB）   
  7775876k used — 使用中的内存总量（7.7GB）   
  530668k free — 空闲内存总量（530M）   
  79236k buffers — 缓存的内存量 （79M）
* 第五行：swap交换分区：LINUX下的虚拟内存分区,它的作用是在物理内存使用完之后,将磁盘空间(也就是SWAP分区)虚拟成内存来使用
    * 只有内存不够用会调用swap的内存
      2031608k total — 交换区总量（2GB）     
      2556k used — 使用的交换区总量（2.5M）    
      2029052k free — 空闲交换区总量（2GB）    
      4231276k cached — 缓冲的交换区总量（4GB）
* 第四行中使用中的内存总量（used）指的是现在系统内核控制的内存数，空闲内存总量（free）是内核还未纳入其管控范围的数量。纳入内核管理的内存不见得都在使用中，还包括过去使用过的现在可以被重复利用的内存，内核并不把这些可被重新使用的内存交还到free中去，因此在linux上free内存会越来越少，但不用为此担心。
* 如果出于习惯去计算可用内存数，这里有个近似的计算公式：第四行的free + 第四行的buffers + 第五行的cached，按这个公式此台服务器的可用内存：530668+79236+4231276 = 4.7GB。
* 对于内存监控，在top里我们要时刻监控第五行swap交换分区的used，如果这个数值在不断的变化，说明内核在不断进行内存和swap的数据交换，这是真正的内存不够用了。
* 第六行是空行
* 第七行以下：各进程（任务）的状态监控   
  PID — 进程id   
  USER — 进程所有者   
  PR — 进程优先级   
  NI — nice值。负值表示高优先级，正值表示低优先级   
  VIRT — 进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES   
  RES — 进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA   
  SHR — 共享内存大小，单位kb   
  S — 进程状态。D=不可中断的睡眠状态 R=运行 S=睡眠 T=跟踪/停止 Z=僵尸进程   
  %CPU — 上次更新到现在的CPU时间占用百分比   
  %MEM — 进程使用的物理内存百分比   
  TIME+ — 进程使用的CPU时间总计，单位1/100秒   
  COMMAND — 进程名称（命令名/命令行）
### ps
命令描述： ps是命令是 Process Status 的缩写，linux下最常用的进程查看命令;
使用技巧：
可以配合管道命令 | 和查找命令 grep 同时执行来查看特定进程。
可以配合管道命令 | 和文本分析命令 awk 同时执行来定位具体进程参数值
命令演示：
ps
ps -A
ps -aux
ps -ef
ps -ef | grep | awk
### linux下定时任务--crontab
* 性能测试使用场景：结合nmon实现定时定点监控服务器性能
* 来源：linux系统是由cron这个系统服务来控制的，在系统中包含很多计划性任务。用户可以自定义计划任务，so-->crontab
* 命令：
    * /sbin/service crond status查看定时任务的服务是否启动
    * start/stop/restart 启动/停止/重启 服务
    * reload 重新载入配置
* 服务权限：
    * crontab的权限管理存储在cron.allow和cron.deny文件中。如果没有可以在/ect/目录下创建
    * 使用场景：
        * 当俩个文件都不存在，只能root使用
        * .allow存在，.deny不存在，只允许allow用户使用
        * .allow不存在，.deny存在，非的deny用户都使用
        * 文件都存在，用户在俩文件中都存在，以allow为准
* 使用：
    * crontab -e:进入编辑页面
    * crontab -l：查看定时任务配置  date查看当前时间
    * crontab -r : 删除 crontab 文件。
    * crontab -ir : 删除 crontab 文件前提醒用户。
    * 基本格式：minute hour day month week command
        * minute:00-59、每分钟用 * 或者 */1标识
        * hour:
          -23(0表示0点)
        * day：日期01-31
        * month：01-12
        * week：0-6（0表示周末）
        * command：
    * 符号： * 代表取值范围所有值   
      / 代表每
        - 代表从start-end   
          , 代表并列多个值
### 万能命令 sar
* 定义：(system activity reporter系统活动情况报告)，是linux全面的性能分析工具
* 用途：文件读写、系统调用、磁盘IO、CPU效率、内存使用、进程活动、IPC活动
* 参数：
    * n:间隔
    * t：次数
    * -o 文件：结果输出到文件
    * [options]:
        * -A：报告综合
        * -u:cpu使用率
        * -r:内存使用情况
        * -B:内存分页情况
        * -b:缓冲区使用情况
### 进程追踪命令 strace
* 用法:系统诊断、调试、统计于一身。可以完整的追踪进程的生命周期
* 参数：
    * -p：指定待跟踪的进程号(pid)
    * -f：跟踪当前进程及其通过fork系统调用所创建的子进程
    * -c：统计和报告每个系统调用所执行的时间、调用次数和出错次数等
    *  -t在每行输出前添加绝对时间戳(当前时钟)信息，精确到秒级    
       -tt在每行输出前添加绝对时间戳信息，精确到微秒级    
       -ttt在每行输出前添加相对时间信息，格式为”自纪元时间起经历的秒数.微秒数”
    * -e expr:指定一个表达式，用于限定跟踪哪些事件及如何跟踪
    * -o file:strace输出信息默认显示到标准错误输出，该选项将输出信息写入文件file中。以下两条命令等效：
* 实例：strace -ff -F -o 文件名  命令      ->使用more命令来分步查看文件内容    
  查看文件中是否有-1，则有错误
### nmon 工具
* 用法：linux广泛使用监控+分析工具
    * 记录信息全面
    * 实时捕捉系统资源的使用情况
    * 输出到文件，图表展示
* 下载安装：wget http://sourceforge.net/projects/nmon/files/nmon16h.tar.gz    解压：tar -zxvf .gz   复制指定包到/usr/bin下
* 参数：
    * -f：必选参数，放在首位，输出文件，默认主机+时间.nmon
    * -F：用户自定义文件名称功能和-f一致
    * -s：采集频率
    * -c: 采集次数
    * -t: 输出最销号资源的进程
* 使用：采集频率+采集次数=性能测试时间
* eg:nmon -f -F /usr/local/blog/result.nmon -s 3 -c 100
* nmon结果数据分析工具--nmon_analyzer(需要使用excel的宏，wps安装插件)
    * 下载：ibm网址
    * 重点sheet页
        * SYS_SUMM  系统汇总页，包含cpu占有率、磁盘、io变化情况等信息
            * 系统汇总,蓝线为cpu占有率变化情况,粉线为磁盘IO的变化情况；
        * AAA 关于操作系统以及nmon本身的一些信息
        * CPUnn 显示执行时间内cpu占用的情况
        * CPU_ALL 所有CPU概述，显示所有CPU平均占用情况
            ```text
              a. User%，用户模式下执行的程序所使用的CPU百分比
              b. Sys%，内核模式下执行的程序所使用的CPU百分比
              c. Wait%，等待 IO 所花的时间百分比
              d. Idel%，CPU的空闲时间百分比，此值和User%，Sys%，Wait%之和等于1
              e. CPU%，CPU总体占用情况，这个值通常等于User%+Sys%+Wait%
              f. CPUs，CPU核数，即操作系统是多少C的
            ```
        * CPU_SUMM 每一个CPU在执行时间内的占用情况
        * DGBUSY 磁盘组每个hdisk设备平均占用情况
        * DGREAD 每个磁盘组的平均读情况
        * DGWRITE 每个磁盘组的平均写情况
        * DGSIZE 每个磁盘组的平均读写情况
        * DGXFER 每个磁盘组的I/O每秒情况
        * MEM 内存相关信息、使用、空闲内存大小等
            ```text
              a. memtotal，物理内存总大小
              
              b. swaptotal，虚拟内存（即交换空间）的总大小
              
              c. memfree，剩余物理内存大小
              
              d. swapfree，剩余虚拟内存大小
              
              e. cached，已占用的文件系统缓存大小，由物理内存分配
              
              f. buffers，文件系统缓冲区大小
              
              g. swapcached，虚拟内存中已分配出来的内存大小
              
              h. inactive，最近不常使用的内存大小
            ```
        * NET 显示系统中每个网络适配器的数据传输速率（千字节/秒）
            ```text
                  a. Total-Read，网络适配器每秒接收的数据包总大小，单位是KB/sec
                  
                  b. Total-Write (-ve)，网络适配器每秒发送的数据包总大小，单位是KB/sec
                  
                  c. eth0-total，网络适配器每秒接收和发送的数据包总大小，单位是KB/sec
            ```
        * PAGE 本sheet统计相关页信息的记录
        * DISK_SUM：总体disk读、写以及I/O操作
            ```text
              a. Disk Read KB/s ，每个磁盘执行采样数据（磁盘设备的读速率）
              b. Disk Write KB/s ，每个磁盘执行采样数据（磁盘设备的写速率）
              c. IO/sec，每秒钟输出到物理磁盘的传输次数
            ```
        * DISKBUSY：每个hdisk设备平均占用情况   单位为%（百分比）